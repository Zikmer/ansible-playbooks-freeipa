---
- name: Configure ipa server

  hosts: ipa_server

  become: true

  vars:

    ipaserver_setup_dns: yes
    ipaserver_auto_forwarders: "{{ ipaserver_forwarders is not defined }}"
    ipaserver_setup_firewalld: no
    ipaserver_allow_zone_overlap: yes
    ipaserver_no_dnssec_validation: yes
    ipaserver_setup_adtrust: yes
    ipaclient_force_join: yes

  roles:

    - bertvv.hosts
    - ipaserver

  tasks:

    - name: disable hardcoded apache redirects in freeipa vhost
      replace:
        path: /etc/httpd/conf.d/ipa-rewrite.conf
        regexp: '{{ item.regexp }}'
        replace: '{{ item.replace }}'
      loop_control:
        label: "{{ item.regexp }}"
      loop:
        - regexp: '^(RewriteRule \^/\$) (https://.*)(/ipa/ui.*)$'
          replace: '\1 \3'
        - regexp: '^(RewriteRule \^\/ipa\/\(.*)$'
          replace: '#\1'
        - regexp: '^(RewriteCond .*)$'
          replace: '#\1'
      become: true

    - block:

        - name: set recursor metadata
          set_fact:
            pdns_recursor_domains: "{{ pdns_recursors | default([]) | product([ipaserver_domain]) | list }}"

        - name: query resolver delegations
          uri:
            url: "https://{{ item }}/api/v1/servers/localhost/zones"
            method: GET
            headers:
              X-API-Key: "{{ pdns_rec_api_key }}"
            validate_certs: no
          loop: "{{ pdns_recursors | default([]) }}"
          register: pdns_recursor_zones
          tags:
            - recursors

        - name: delete resolver delegations
          uri:
            url: "https://{{ recursor }}/api/v1/servers/localhost/zones/{{ zone_id }}"
            method: DELETE
            status_code:
              - 200
              - 204
            headers:
              X-API-Key: "{{ pdns_rec_api_key }}"
          loop_control:
            label: "{{ recursor }}: {{ zone_name }}"
          vars:
            recursor: "{{ item.0 }}"
            zone_name: "{{ item.1 }}"
            recursor_zones: "{{ pdns_recursor_zones.results | selectattr('item', 'equalto', recursor) | first }}"
            zone_id: "{{ (recursor_zones.json | selectattr('name', 'match', zone_name + '\\.?') | first).id | default('') }}"
          loop: "{{ pdns_recursor_domains }}"
          when: zone_id != ''
          tags:
            - recursors

        - name: create recursor delegation
          uri:
            url: "https://{{ recursor }}/api/v1/servers/localhost/zones"
            method: POST
            status_code:
              - 200
              - 201
            body_format: json
            body:
              name: "{{ zone_name }}"
              type: Zone
              kind: Forwarded
              servers: "{{ play_hosts | map('extract', hostvars, ['ansible_default_ipv4', 'address']) | list }}"
              recursion_desired: yes
            headers:
              X-API-Key: "{{ pdns_rec_api_key }}"
          loop_control:
            label: "{{ recursor }}: {{ zone_name }}"
          vars:
            recursor: "{{ item.0 }}"
            zone_name: "{{ item.1 | regex_replace('\\.?$', '') }}."
          loop: "{{ pdns_recursor_domains }}"

      when: pdns_recursors is defined

    - name: create host record in freeipa dns
      ipa_dnsrecord:
        ipa_host: "{{ ansible_fqdn }}"
        ipa_user: "{{ ipaadmin_principal }}"
        ipa_pass: "{{ ipaadmin_password }}"
        zone_name: "{{ ipaserver_domain }}"
        record_name: '@'
        record_type: A
        record_value: "{{ ansible_default_ipv4.address }}"
        validate_certs: no

    - name: manage freeipa backup cronjob
      cron:
        name: freeipa-conf-backup
        job: ipa-backup
        special_time: daily

  handlers:

    - name: restart ipa services
      command: "ipactl restart"

    - name: restart apache
      service:
        name: httpd
        state: restarted
